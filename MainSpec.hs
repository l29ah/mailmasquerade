{-# LANGUAGE OverloadedStrings #-}
module MainSpec (spec) where

import Data.ByteString
import Data.Either
import qualified Data.IMF as PB
import qualified Data.MIME as PB
import MailMasquerade
import Test.Hspec

mail = "Received: from postback29a.mail.yandex.net (postback29a.mail.yandex.net [2a02:6b8:c0e:500:1:45:d181:da29])\r\n\tby lciq6bmapqvyxsi4.vla.yp-c.yandex.net (notsolitesrv/Yandex) with LMTP id pa1KWQWWIMPW-vUgDKuC6\r\n\tfor <buh@organikum.io>; Thu, 08 Feb 2024 18:37:58 +0300\r\nReceived: from mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net (mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net [IPv6:2a02:6b8:c0d:178f:0:640:ed6d:0])\r\n\tby postback29a.mail.yandex.net (Yandex) with ESMTPS id 57BE25E55D\r\n\tfor <buh@organikum.io>; Thu,  8 Feb 2024 18:37:58 +0300 (MSK)\r\nReceived: from mx50.moedelo.org (mx50.moedelo.org [151.236.114.89])\r\n\tby mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net (mxfront/Yandex) with ESMTPS id vbkql0NobeA0-9WKU8SqL;\r\n\tThu, 08 Feb 2024 18:37:58 +0300\r\nX-Yandex-Fwd: 1\r\nAuthentication-Results: mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net; spf=pass (mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net: domain of moedelo.org designates 151.236.114.89 as permitted sender, rule=[ip4:151.236.114.89]) smtp.mail=buh@moedelo.org; dkim=pass header.i=@moedelo.org\r\nX-Yandex-Spam: 1\r\nDKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed; d=moedelo.org\r\n\t; s=mail; h=Content-Transfer-Encoding:Content-Type:Subject:Date:Cc:To:From:\r\n\tMIME-Version:References:Message-ID:Sender:Reply-To:Content-ID:\r\n\tContent-Description:Resent-Date:Resent-From:Resent-Sender:Resent-To:Resent-Cc\r\n\t:Resent-Message-ID:In-Reply-To:List-Id:List-Help:List-Unsubscribe:\r\n\tList-Subscribe:List-Post:List-Owner:List-Archive;\r\n\tbh=jz9v/EvP8tf3HRCCCIf953ZwlrBDYyyL4x36KDCs6KM=; b=bRfxRMmgvZmlS4L4+jTDZUlxvO\r\n\t3eKi10HMMO7sFcQ4NsgXIYgOHSrFQocwO7qnwB1CfDXC2+WykoxhVVv/ydmB+sMWxWLKhHN1nK3+5\r\n\tn+om5ioVfhrv2Dant79l/2Yaf3pNwqf8o4gINEwRHIxHeDJPx7FaR2TinbchPgL/e3gE=;\r\nMessage-ID: <acf6f926-366b-4ff9-979e-6d2e5027fc99@auto.moedelo.org>\r\nReferences: <4931707341630@mail.yandex.ru>\r\nMIME-Version: 1.0\r\nFrom: =?utf-8?Q?=D0=90=D0=BD=D0=BD=D0=B0_=D0=92=D0=B0=D1=80=D0=B7?=\r\n =?utf-8?Q?=D0=B8=D0=BD=D0=B0?= <buh@moedelo.org>\r\nTo: ndtimofeev@gmail.com\r\nCc: ndtimofeev@gmail.com, buh@organikum.io\r\nDate: 8 Feb 2024 18:37:57 +0300\r\nSubject: =?utf-8?B?0JzQsNGI0LjQvdC+0YfQuNGC0LDQtdC80LDRjyDQtNC+0LI=?=\r\n =?utf-8?B?0LXRgNC10L3QvdC+0YHRgtGM?=\r\nContent-Type: text/html; charset=utf-8\r\nContent-Transfer-Encoding: base64\r\nReturn-Path: buh@moedelo.org\r\nX-Yandex-Forward: 6fdffb2d7917ad04d04433d56e497a19\r\n\r\n77u/PCFET0NUWVBFIEhUTUwgUFVCTElDICItLy9XM0MvL0RURCBIVE1MIDQuMCBUcmFu\r\nc2l0aW9uYWwvL0VOIj4KPGh0bWw+CjxoZWFkPgogICAgPG1ldGEgaHR0cC1lcXVpdj0i\r\nQ29udGVudC1UeXBlIiBjb250ZW50PSJ0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgiIC8+\r\nCiAgICA8dGl0bGU+PC90aXRsZT4KICAgIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAg\r\nICAgICAgQG1lZGlhIG9ubHkgc2NyZWVuIGFuZCAobWF4LXdpZHRoOiA2MDBweCkgewog\r\nICAgICAgICAgICAud2lkdGgtNjAwIHsKICAgICAgICAgICAgICAgIHdpZHRoOiAxMDAl\r\nICFpbXBvcnRhbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLmhpZGUtNjAwIHsK\r\nICAgICAgICAgICAgICAgIGRpc3BsYXk6bm9uZTsKICAgICAgICAgICAgfQogICAgICAg\r\nIH0KICAgIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CjwhLS0gcHJlaGVhZGVyIC0tPgo8\r\nc3BhbiBzdHlsZT0iZGlzcGxheTpub25lOyBmb250LXNpemU6MXB4OyBjb2xvcjojMzMz\r\nMzMzIWltcG9ydGFudDsgbGluZS1oZWlnaHQ6MXB4OyBtYXgtaGVpZ2h0OjBweDsgbWF4\r\nLXdpZHRoOjBweDsgb3BhY2l0eTowOyBvdmVyZmxvdzpoaWRkZW47Ij48L3NwYW4+Cjwh\r\nLS0gL3ByZWhlYWRlciAtLT4KPHRhYmxlIGJvcmRlcj0iMCIgY2VsbHBhZGRpbmc9IjAi\r\nIGNlbGxzcGFjaW5nPSIwIiBiZ2NvbG9yPSIjZjhmNmY2IiB3aWR0aD0iMTAwJSIgc3R5\r\nbGU9Im1hcmdpbjowOyBwYWRkaW5nOjA7IHdpZHRoOjEwMCU7IGJvcmRlci1jb2xsYXBz\r\nZTpjb2xsYXBzZTsgZm9udC1mYW1pbHk6IEhlbHZldGljYSwgQXJpYWwsIFZlcmRhbmEs\r\nICdUcmVidWNoZXQgTVMnLCBzYW5zLXNlcmlmOyBmb250LXNpemU6MTZweDsgbGluZS1o\r\nZWlnaHQ6MTlweDsgY29sb3I6IzRjNGM0YyFpbXBvcnRhbnQ7IC13ZWJraXQtdGV4dC1z\r\naXplLWFkanVzdDpub25lOyI+CiAgICA8dGJvZHk+CiAgICAgICAgPHRyPgogICAgICAg\r\nICAgICA8dGQgYWxpZ249ImNlbnRlciIgc3R5bGU9InBhZGRpbmc6IDE5cHggMTVweCAx\r\nOXB4IDE1cHg7Ij4KICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzcz0id2lkdGgtNjAw\r\nIiBib3JkZXI9IjAiIGNlbGxwYWRkaW5nPSIwIiBjZWxsc3BhY2luZz0iMCIgYmdjb2xv\r\ncj0iI2ZmZmZmZiIgd2lkdGg9IjYwMCIgc3R5bGU9Im1hcmdpbjowIGF1dG87IHBhZGRp\r\nbmc6MDsgd2lkdGg6NjAwcHg7IGJvcmRlci1jb2xsYXBzZTpjb2xsYXBzZTsiPgogICAg\r\nICAgICAgICAgICAgICAgIDx0Ym9keT4KICAgICAgICAgICAgICAgICAgICAgICAgPHRy\r\nPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGFsaWduPSJjZW50ZXIiIHN0\r\neWxlPSJwYWRkaW5nOiA0NXB4IDAgNDBweCAwOyI+CiAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgPHRhYmxlIGJvcmRlcj0iMCIgY2VsbHBhZGRpbmc9IjAiIGNlbGxz\r\ncGFjaW5nPSIwIiB3aWR0aD0iODYlIiBzdHlsZT0ibWFyZ2luOjAgYXV0bzsgcGFkZGlu\r\nZzowOyB3aWR0aDo4NiU7IGJvcmRlci1jb2xsYXBzZTpjb2xsYXBzZTsgIj4KICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRib2R5PgogICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZCBhbGlnbj0ibGVmdCIgdmFsaWduPSJt\r\naWRkbGUiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgPGltZyBzcmM9Imh0dHBzOi8vc3QubWRzdGF0aWMub3JnL1Byb21vL2lt\r\nZy9idWhzZXJ2aWNlLnBuZyIgYWx0PSLQnNC+0ZEg0LTQtdC70L4u0JHRg9GF0LPQsNC7\r\n0YLQtdGAIiBib3JkZXI9IjAiIHN0eWxlPSJkaXNwbGF5OmJsb2NrOyB3aWR0aDoxMDAl\r\nOyBoZWlnaHQ6YXV0bzsgbWF4LXdpZHRoOjM3NnB4OyB2ZXJ0aWNhbC1hbGlnbjp0b3A7\r\nIiAvPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nICA8L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90\r\ncj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90Ym9keT4KICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgPC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4K\r\nICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgPHRkIGFsaWduPSJjZW50ZXIiPgogICAgICAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgIDx0YWJsZSBib3JkZXI9IjAiIGNlbGxwYWRkaW5nPSIwIiBjZWxsc3BhY2lu\r\nZz0iMCIgd2lkdGg9Ijg2JSIgc3R5bGU9Im1hcmdpbjowIGF1dG87IHBhZGRpbmc6MDsg\r\nd2lkdGg6ODYlOyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0\r\nYm9keT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4K\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgaGVp\r\nZ2h0PSIxIiBiZ2NvbG9yPSIjZTNlM2UzIiBhbGlnbj0iY2VudGVyIj4KICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0i\r\nd2lkdGg6MTAwJTsgaGVpZ2h0OjFweDsgYmFja2dyb3VuZC1jb2xvcjojZTNlM2UzOyI+\r\nPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nPC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+\r\nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIHN0eWxlPSJw\r\nYWRkaW5nLXRvcDogMjBweDsiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6IEhlbHZldGlj\r\nYSwgQXJpYWwsIFZlcmRhbmEsICdUcmVidWNoZXQgTVMnLCBzYW5zLXNlcmlmOyBmb250\r\nLXNpemU6MTRweDsgbGluZS1oZWlnaHQ6MjJweDsgY29sb3I6Izc3Nzc3NyFpbXBvcnRh\r\nbnQ7IC13ZWJraXQtdGV4dC1zaXplLWFkanVzdDpub25lOyBkaXNwbGF5OmJsb2NrOyI+\r\nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwv\r\nc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8\r\nL3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4K\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgc3R5bGU9InBh\r\nZGRpbmctdG9wOiAyNXB4OyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LWZhbWlseTogSGVsdmV0aWNh\r\nLCBBcmlhbCwgVmVyZGFuYSwgJ1RyZWJ1Y2hldCBNUycsIHNhbnMtc2VyaWY7IGZvbnQt\r\nc2l6ZToxNHB4OyBsaW5lLWhlaWdodDoyMnB4OyBjb2xvcjojNzc3Nzc3IWltcG9ydGFu\r\ndDsgLXdlYmtpdC10ZXh0LXNpemUtYWRqdXN0Om5vbmU7IGRpc3BsYXk6YmxvY2s7d2hp\r\ndGUtc3BhY2U6IHByZS13cmFwOyB3b3JkLWJyZWFrOiBicmVhay13b3JkOyI+PHA+0JTQ\r\nvtCx0YDRi9C5INC00LXQvdGMISDQkdC+0LvRjNGI0L7QtSDQutC+0LvQuNGH0LXRgdGC\r\n0LLQviDQt9Cw0Y/QstC+0Log0L3QsCDQstGL0L/Rg9GB0Log0JzQp9CULCDRgdC+0YLR\r\ngNGD0LTQvdC40LrQuCDQstGL0L/Rg9GB0LrQsNGO0YIg0LIg0L/QvtGA0Y/QtNC60LUg\r\n0L7Rh9C10YDQtdC00LguJm5ic3A7PC9wPjxwPtCi0L7Rh9C90YvQtSDRgdGA0L7QutC4\r\nLCDQuiDRgdC+0LbQsNC70LXQvdC40Y4sINGB0LvQvtC20L3QviDQvtC30LLRg9GH0LjR\r\ngtGMLjwvcD48cD7QldGB0LvQuCDQktCw0Lwg0L3QtdC+0LHRhdC+0LTQuNC80L4g0LrQ\r\nsNC6INC80L7QttC90L4g0LHRi9GB0YLRgNC10LUg0LLRi9C/0YPRgdGC0LjRgtGMINCc\r\n0KfQlCwg0Y8g0L/QvtC/0YDQvtGI0YMg0YfRgtC+0LHRiyDQtNC70Y8g0JLQsNGBINGB\r\n0LTQtdC70LDQu9C4INC60LDQuiDQvNC+0LbQvdC+INC+0L/QtdGA0LDRgtC40LLQvdC1\r\n0LUuPC9wPjxwPjxicj48L3A+PGJyPtChINGD0LLQsNC20LXQvdC40LXQvCwg0JLQsNGA\r\n0LfQuNC90LAg0JDQvdC90LA8YnI+0JHQuNC30L3QtdGBLdCw0YHRgdC40YHRgtC10L3R\r\ngjxicj5idWhAbW9lZGVsby5vcmc8YnI+ODgwMDIwMDc5Mjc8L3NwYW4+CiAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90ZD4KICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgPHRkIHN0eWxlPSJwYWRkaW5nLXRvcDogMjBw\r\neDsiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nICA8c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6IEhlbHZldGljYSwgQXJpYWwsIFZlcmRh\r\nbmEsICdUcmVidWNoZXQgTVMnLCBzYW5zLXNlcmlmOyBmb250LXNpemU6MTRweDsgbGlu\r\nZS1oZWlnaHQ6MjJweDsgY29sb3I6Izc3Nzc3NyFpbXBvcnRhbnQ7IGZvbnQtc3R5bGU6\r\nIFJlZ3VsYXI7IC13ZWJraXQtdGV4dC1zaXplLWFkanVzdDpub25lOyBkaXNwbGF5OmJs\r\nb2NrO3doaXRlLXNwYWNlOiBwcmUtd3JhcDsgd29yZC1icmVhazogYnJlYWstd29yZDsi\r\nPtCj0YHQv9C10YXQvtCyINCyINC00LXQu9Cw0YUhINCa0L7QvNCw0L3QtNCwINCc0L7Q\r\ntSDQtNC10LvQvi4g0JHRg9GF0L7QsdGB0LvRg9C20LjQstCw0L3QuNC1Ljwvc3Bhbj4K\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RkPgog\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgc3R5bGU9InBhZGRpbmct\r\ndG9wOiAyMHB4OyAiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICA8c3BhbiBzdHlsZT0idmVydGljYWwtYWxpZ246IHN1cGVyOyBkaXNw\r\nbGF5OiBpbmxpbmU7IHBhZGRpbmctcmlnaHQ6IDEwcHg7IHBhZGRpbmctdG9wOiAxMHB4\r\nOyBmb250LWZhbWlseTogSGVsdmV0aWNhLCBBcmlhbCwgVmVyZGFuYSwgJ1RyZWJ1Y2hl\r\ndCBNUycsIHNhbnMtc2VyaWY7IGZvbnQtc2l6ZToxNHB4OyBsaW5lLWhlaWdodDoyMnB4\r\nOyBjb2xvcjojNzc3Nzc3IWltcG9ydGFudDsgZm9udC1zdHlsZTogUmVndWxhcjsgLXdl\r\nYmtpdC10ZXh0LXNpemUtYWRqdXN0Om5vbmU7IHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsg\r\nd29yZC1icmVhazogYnJlYWstd29yZDsiPtCf0L7QttCw0LvRg9C50YHRgtCwLCDQvtGG\r\n0LXQvdC40YLQtSDRgNCw0LHQvtGC0YMg0YHQvtGC0YDRg9C00L3QuNC60LA8L3NwYW4+\r\nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxh\r\nIGhyZWY9Imh0dHA6Ly9tb2VkZWxvLm9yZy9tZXNzYWdlLXJhdGUtb3V0c291cmNlP3Rv\r\na2VuPWV5SmhiR2NpT2lKU1V6STFOaUlzSW5SNWNDSTZJa3BYVkNKOS5leUpCWTJOdmRX\r\nNTBTV1FpT2pNME16a3lORGtzSWsxbGMzTmhaMlZTWVhSbFNXUWlPamt4TlRneE9Dd2lR\r\nM0psWVhSbFJHRjBaU0k2SWpJd01qUXRNREl0TURoVU1UZzZNemM2TlRjdU9UQTFNalEx\r\nTnlzd016b3dNQ0lzSWtWNGNHbHlZWFJwYjI1RVlYUmxJam9pTWpBeU5DMHdNaTB3T0ZR\r\neU1Eb3pOem8xTnk0NU1EVXlORFUzS3pBek9qQXdJaXdpVW1GMFpTSTZNSDAuZ0EwbVVS\r\nNTgtTnRQX25JNE45SnM4ODVOSUZ6Uy1jNENRbng3eFdqRVJ3U04xalpxczluUzlDbk12\r\nRFFJME9GTi12Y0tYZmpqNHl0ZUNzX0ViWXg4Um84clVsUVVITmZpLXZxX24tb0xUSTV1\r\nT2dZWWpacU1MZHVxc3RzZlZhWW9LOVAxbDE3MFktalBydmpmSTJicFgwQVNwTWJvNFN6\r\naEh6SjR3MzZzNE9BZE9yVk9UbTFsUjFGZGdRRFkwazZGT0FhVmFaN05RdzA4b29lcDNJ\r\nSWZhbEkyNVJ2LWxaZzZNcXd1NWN0ZTZMX3VxOFFKelhBcWd5cFR3ZlZudmZlUlV4Vjcy\r\nQTlSRjI3ZVpMb2N4dldwMjZlNUdHR25fT09UeUJIUUZHeEZieVg3TTJuZWpiOG5uQkhP\r\naE9QbC1FWk0zUDMza1JTQ1dod0xuWnpWek9oanJnIj48aW1nIHNyYz0iaHR0cHM6Ly9z\r\ndC5tZHN0YXRpYy5vcmcvUHJvbW8vaW1nL2xpa2UucG5nIiBhbHQ9ItCb0LDQudC6IiBi\r\nb3JkZXI9IjAiIHdpZHRoPSIzNSIgc3R5bGU9ImRpc3BsYXk6aW5saW5lOyB2ZXJ0aWNh\r\nbC1hbGlnbjpib3R0b207IG1hcmdpbi10b3A6NXB4OyBtYXJnaW4tcmlnaHQ6NXB4OyIv\r\nPjwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nICAgPGEgaHJlZj0iaHR0cDovL21vZWRlbG8ub3JnL21lc3NhZ2UtcmF0ZS1vdXRzb3Vy\r\nY2U/dG9rZW49ZXlKaGJHY2lPaUpTVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SkJZ\r\nMk52ZFc1MFNXUWlPak0wTXpreU5Ea3NJazFsYzNOaFoyVlNZWFJsU1dRaU9qa3hOVGd4\r\nT0N3aVEzSmxZWFJsUkdGMFpTSTZJakl3TWpRdE1ESXRNRGhVTVRnNk16YzZOVGN1T1RB\r\nMU1EQTVPU3N3TXpvd01DSXNJa1Y0Y0dseVlYUnBiMjVFWVhSbElqb2lNakF5TkMwd01p\r\nMHdPRlF5TURvek56bzFOeTQ1TURVd01EazVLekF6T2pBd0lpd2lVbUYwWlNJNk1YMC5K\r\nTGVoUy11V1NGQ1o4M1hTUnpaTy1nbmZ0bEZlSURsbHR6dE1XUE1YTjBjTURZYW5PSTd0\r\naVFpeTViUkVfTjIyQndpb21YVXphMFF4TTRuanpwRDdINkktck5JVHhuVnIwWjR3XzNn\r\nYVhhSlZKOE9fUXB4dk9MREZIMzRic05wS19KcVltR0xnUDhtMVRYSkQyRkhGeGx6aDAy\r\nWnVHSGNxYjZFVFFLWTJBb3R1R24wcm12NFBhb0V2cnVzUVlEN1Q2dE5vSzJNYl9VYlRD\r\nQkVJS3JkTXR0R3VZNzFLaWE1RmRYWFZ0elZvdEpENE1INGhQa3pBS01GaHFSdTVQdmRX\r\nMldRU3hYTUdOLTNQYzltR083ZE14TnlUTi1SV3VDc2lKTk0wT0dRenJhSlc1WWUtcGZj\r\nbUVRZTZaRzBSRDZPbUhidC1JQk9XRldtMEtFZGE4MHRTMHciPjxpbWcgc3JjPSJodHRw\r\nczovL3N0Lm1kc3RhdGljLm9yZy9Qcm9tby9pbWcvZGlzbGlrZS5wbmciIGFsdD0i0JTQ\r\nuNC30LDQudC6IiBib3JkZXI9IjAiIHdpZHRoPSIzNSIgc3R5bGU9ImRpc3BsYXk6aW5s\r\naW5lOyB2ZXJ0aWNhbC1hbGlnbjp0b3A7IG1hcmdpbi10b3A6NXB4OyBtYXJnaW4tcmln\r\naHQ6NXB4OyIvPjwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgICA8L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nICAgPC90cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0\r\ncj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQg\r\nc3R5bGU9InBhZGRpbmctdG9wOiAxMHB4O3BhZGRpbmctYm90dG9tOiAzMHB4OyI+CiAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFu\r\nIHN0eWxlPSJmb250LWZhbWlseTogSGVsdmV0aWNhLCBBcmlhbCwgVmVyZGFuYSwgJ1Ry\r\nZWJ1Y2hldCBNUycsIHNhbnMtc2VyaWY7IGZvbnQtc2l6ZToxNHB4OyBsaW5lLWhlaWdo\r\ndDoyMnB4OyBjb2xvcjojNzc3Nzc3IWltcG9ydGFudDsgZm9udC1zdHlsZTogUmVndWxh\r\ncjsgLXdlYmtpdC10ZXh0LXNpemUtYWRqdXN0Om5vbmU7IGRpc3BsYXk6YmxvY2s7d2hp\r\ndGUtc3BhY2U6IHByZS13cmFwOyB3b3JkLWJyZWFrOiBicmVhay13b3JkOyI+0J/QvtC0\r\n0YDQvtCx0L3Ri9C5INC+0YLQt9GL0LIg0LLRiyDQvNC+0LbQtdGC0LUg0L7RgdGC0LDQ\r\nstC40YLRjCwg0L3QsNC/0LjRgdCw0LIg0L3QsCDQv9C+0YfRgtGDIDxhIGhyZWY9Im1h\r\naWx0bzpvdHppdkBtb2VkZWxvLm9yZyI+b3R6aXZAbW9lZGVsby5vcmc8L2E+Ljwvc3Bh\r\nbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3Rk\r\nPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgaGVpZ2h0PSIxIiBi\r\nZ2NvbG9yPSIjZTNlM2UzIiBhbGlnbj0iY2VudGVyIj4KICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0id2lkdGg6MTAw\r\nJTsgaGVpZ2h0OjFweDsgYmFja2dyb3VuZC1jb2xvcjojZTNlM2UzOyI+PC9kaXY+CiAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90ZD4KICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIHN0eWxlPSJwYWRkaW5nLXRv\r\ncDogMjBweDsgcGFkZGluZy1ib3R0b206IDMwcHg7Ij4KICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9InZlcnRpY2Fs\r\nLWFsaWduOiBtaWRkbGU7IGRpc3BsYXk6IGlubGluZTsgZm9udC1zaXplOjE0cHg7bGlu\r\nZS1oZWlnaHQ6MjJweDtjb2xvcjojNzc3Nzc3IWltcG9ydGFudDtmb250LXN0eWxlOiBS\r\nZWd1bGFyOyBwYWRkaW5nLXJpZ2h0OiA1cHg7Ij4KICAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgINCU0LvRjyDQstCw0YEg0LzRiyDQ\r\nv9GD0LHQu9C40LrRg9C10Lwg0L3QvtCy0L7RgdGC0Lgg0LfQsNC60L7QvdC+0LTQsNGC\r\n0LXQu9GM0YHRgtCy0LAg0Lgg0YHQtdGA0LLQuNGB0LAKICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSJodHRwczov\r\nL3QubWUvbWRfQVVUIiBzdHlsZT0idmVydGljYWwtYWxpZ246IG1pZGRsZTtkaXNwbGF5\r\nOiBpbmxpbmU7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgIDxpbWcgd2lkdGg9IjE2IiBzcmM9Imh0dHBzOi8vd3d3Lm1vZWRl\r\nbG8ub3JnL3N0eWxlL2ltZy9tYWlsLXNvY2lhbC1pY29ucy90Zy5wbmciPgogICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2E+CiAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90ZD4KICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgICAgICAgICAgIDwvdGJvZHk+CiAgICAgICAgICAgICAgICAg\r\nICAgICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgICAgICAgICAgICAgICAgICAg\r\nIDwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAg\r\nICAgICAgPC90Ym9keT4KICAgICAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgICAg\r\nIDwvdGQ+CiAgICAgICAgPC90cj4KICAgIDwvdGJvZHk+CjwvdGFibGU+CjwvYm9keT4K\r\nPC9odG1sPg==\r\n\r\n" :: ByteString

parseMail :: ByteString -> PB.Message PB.EncStateWire PB.MIME
parseMail m = fromRight undefined $ PB.parse (PB.message PB.mime) m
parsedMail = parseMail mail

getHeaders m = case m of PB.Message (PB.Headers x) _ -> x

spec :: Spec
spec = do
	describe "adjustMailForForwarding" $ do
		it "passes a basic case" $ do
			(getHeaders $ parseMail $ toStrict $ adjustMailForForwarding parsedMail "foo" "baz") `shouldBe` [("From","foo"),("To","baz"),("Received","from postback29a.mail.yandex.net (postback29a.mail.yandex.net [2a02:6b8:c0e:500:1:45:d181:da29]) by lciq6bmapqvyxsi4.vla.yp-c.yandex.net (notsolitesrv/Yandex) with LMTP id pa1KWQWWIMPW-vUgDKuC6 for <buh@organikum.io>; Thu, 08 Feb 2024 18:37:58 +0300"),("Received","from mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net (mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net [IPv6:2a02:6b8:c0d:178f:0:640:ed6d:0]) by postback29a.mail.yandex.net (Yandex) with ESMTPS id 57BE25E55D for <buh@organikum.io>; Thu, 8 Feb 2024 18:37:58 +0300 (MSK)"),("Received","from mx50.moedelo.org (mx50.moedelo.org [151.236.114.89]) by mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net (mxfront/Yandex) with ESMTPS id vbkql0NobeA0-9WKU8SqL; Thu, 08 Feb 2024 18:37:58 +0300"),("X-Yandex-Fwd","1"),("Authentication-Results","mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net; spf=pass (mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net: domain of moedelo.org designates 151.236.114.89 as permitted sender, rule=[ip4:151.236.114.89]) smtp.mail=buh@moedelo.org; dkim=pass header.i=@moedelo.org"),("X-Yandex-Spam","1"),("DKIM-Signature","v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed; d=moedelo.org ; s=mail; h=Content-Transfer-Encoding:Content-Type:Subject:Date:Cc:To:From: MIME-Version:References:Message-ID:Sender:Reply-To:Content-ID: Content-Description:Resent-Date:Resent-From:Resent-Sender:Resent-To:Resent-Cc :Resent-Message-ID:In-Reply-To:List-Id:List-Help:List-Unsubscribe: List-Subscribe:List-Post:List-Owner:List-Archive; bh=jz9v/EvP8tf3HRCCCIf953ZwlrBDYyyL4x36KDCs6KM=; b=bRfxRMmgvZmlS4L4+jTDZUlxvO 3eKi10HMMO7sFcQ4NsgXIYgOHSrFQocwO7qnwB1CfDXC2+WykoxhVVv/ydmB+sMWxWLKhHN1nK3+5 n+om5ioVfhrv2Dant79l/2Yaf3pNwqf8o4gINEwRHIxHeDJPx7FaR2TinbchPgL/e3gE=;"),("Message-ID","<acf6f926-366b-4ff9-979e-6d2e5027fc99@auto.moedelo.org>"),("References","<4931707341630@mail.yandex.ru>"),("MIME-Version","1.0"),("X-Original-From","=?utf-8?Q?=D0=90=D0=BD=D0=BD=D0=B0_=D0=92=D0=B0=D1=80=D0=B7?= =?utf-8?Q?=D0=B8=D0=BD=D0=B0?= <buh@moedelo.org>"),("X-Original-To","ndtimofeev@gmail.com"),("Cc","ndtimofeev@gmail.com, buh@organikum.io"),("Date","8 Feb 2024 18:37:57 +0300"),("Subject","=?utf-8?B?0JzQsNGI0LjQvdC+0YfQuNGC0LDQtdC80LDRjyDQtNC+0LI=?= =?utf-8?B?0LXRgNC10L3QvdC+0YHRgtGM?="),("Content-Type","text/html; charset=utf-8"),("Content-Transfer-Encoding","base64"),("Return-Path","buh@moedelo.org"),("X-Yandex-Forward","6fdffb2d7917ad04d04433d56e497a19")]
	describe "adjustMailReply" $ do
		it "passes a basic case" $ do
			(getHeaders $ parseMail $ toStrict $ adjustMailReply parsedMail "foo" ("baz" :: String)) `shouldBe` [("Received","from postback29a.mail.yandex.net (postback29a.mail.yandex.net [2a02:6b8:c0e:500:1:45:d181:da29]) by lciq6bmapqvyxsi4.vla.yp-c.yandex.net (notsolitesrv/Yandex) with LMTP id pa1KWQWWIMPW-vUgDKuC6 for <buh@organikum.io>; Thu, 08 Feb 2024 18:37:58 +0300"),("Received","from mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net (mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net [IPv6:2a02:6b8:c0d:178f:0:640:ed6d:0]) by postback29a.mail.yandex.net (Yandex) with ESMTPS id 57BE25E55D for <buh@organikum.io>; Thu, 8 Feb 2024 18:37:58 +0300 (MSK)"),("Received","from mx50.moedelo.org (mx50.moedelo.org [151.236.114.89]) by mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net (mxfront/Yandex) with ESMTPS id vbkql0NobeA0-9WKU8SqL; Thu, 08 Feb 2024 18:37:58 +0300"),("X-Yandex-Fwd","1"),("Authentication-Results","mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net; spf=pass (mail-nwsmtp-mxfront-production-main-81.vla.yp-c.yandex.net: domain of moedelo.org designates 151.236.114.89 as permitted sender, rule=[ip4:151.236.114.89]) smtp.mail=buh@moedelo.org; dkim=pass header.i=@moedelo.org"),("X-Yandex-Spam","1"),("DKIM-Signature","v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed; d=moedelo.org ; s=mail; h=Content-Transfer-Encoding:Content-Type:Subject:Date:Cc:To:From: MIME-Version:References:Message-ID:Sender:Reply-To:Content-ID: Content-Description:Resent-Date:Resent-From:Resent-Sender:Resent-To:Resent-Cc :Resent-Message-ID:In-Reply-To:List-Id:List-Help:List-Unsubscribe: List-Subscribe:List-Post:List-Owner:List-Archive; bh=jz9v/EvP8tf3HRCCCIf953ZwlrBDYyyL4x36KDCs6KM=; b=bRfxRMmgvZmlS4L4+jTDZUlxvO 3eKi10HMMO7sFcQ4NsgXIYgOHSrFQocwO7qnwB1CfDXC2+WykoxhVVv/ydmB+sMWxWLKhHN1nK3+5 n+om5ioVfhrv2Dant79l/2Yaf3pNwqf8o4gINEwRHIxHeDJPx7FaR2TinbchPgL/e3gE=;"),("Message-ID","<acf6f926-366b-4ff9-979e-6d2e5027fc99@auto.moedelo.org>"),("References","<4931707341630@mail.yandex.ru>"),("MIME-Version","1.0"),("From","foo"),("To","baz"),("Cc","ndtimofeev@gmail.com, buh@organikum.io"),("Date","8 Feb 2024 18:37:57 +0300"),("Subject","=?utf-8?B?0JzQsNGI0LjQvdC+0YfQuNGC0LDQtdC80LDRjyDQtNC+0LI=?= =?utf-8?B?0LXRgNC10L3QvdC+0YHRgtGM?="),("Content-Type","text/html; charset=utf-8"),("Content-Transfer-Encoding","base64"),("Return-Path","buh@moedelo.org"),("X-Yandex-Forward","6fdffb2d7917ad04d04433d56e497a19")]
	describe "purgeReplyTo" $ do
		it "passes a basic case" $ do
			purgeReplyTo [("reply-to", "666"), ("dont-reply-to", "13")] `shouldBe` [("dont-reply-to", "13")]
